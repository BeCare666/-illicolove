<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./../assets/img/logoilli.jpeg" rel="icon">
    <title>Document</title>
    <link rel="stylesheet" href="usersendID.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.2/dist/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.2/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container" id="uploadCNIMYID">
        <h1>Télécharger la preuve d'identité
            <small>Avec aperçu</small>
        </h1>
        <div class="avatar-upload">
            <div class="avatar-edit">
                <input type='file' id="imageUpload" accept=".png, .jpg, .jpeg" />
                <label for="imageUpload"></label>
            </div>
            <div class="avatar-preview">
                <div id="imagePreview" style="background-image: url(http://i.pravatar.cc/500?img=7);">
                </div>
            </div>
        </div>
       <h1> <button class="custom-btn btn-5" style="align-items: center !important;" id="SENDID">Envoyer</button></h1>
    </div>
    <script >
    // Configuration Firebase (remplacez par vos propres informations)
    const firebaseConfig = {
        apiKey: "AIzaSyCDGjJ1-gLtw0__8Om8OEzbXYNgBPWw1ik",
        authDomain: "illicolove0.firebaseapp.com",
        databaseURL: "https://illicolove0-default-rtdb.firebaseio.com",
        projectId: "illicolove0",
        storageBucket: "illicolove0.appspot.com",
        messagingSenderId: "687063035754",
        appId: "1:687063035754:web:7f03061d8cd5fd0ee9bf13"
    };

    // Initialisez Firebase
    firebase.initializeApp(firebaseConfig);

    // Récupérez la référence de la base de données
    const database = firebase.database();
    // Générer un lien et le sauvegarder dans la base de données
    function genererLien() {
    const urlParams = new URLSearchParams(window.location.search);
    const UserId = urlParams.get('id');

    if(UserId){
    // Récupérer les données une seule fois
    database.ref('utilisateurs/' + UserId).once('value')
        .then(function(snapshot) {
            // La snapshot contient les données
            var data = snapshot.val();
            if (data) {
            if(data.MESDEUXPHOTOS){
            //console.log("Date d'expiration:", data.DATEUPLOADCNI);
            // Date actuelle
            var dateActuelle = new Date();
            var EXPIRED = data.DATEUPLOADCNI
            if(!EXPIRED){
            var differenceEnMillisecondes =  dateActuelle - EXPIRED;
            var differenceEnMinutes = differenceEnMillisecondes / 60;
            console.log(differenceEnMinutes)
            var UPloadCNIMYID = document.getElementById('uploadCNIMYID');
            if(differenceEnMinutes = 0){
                UPloadCNIMYID.style.display = "none"
                alert(`vous ne pouvez plus envoyer CNI`)
            }else{
             var  base64Contenttable = []
            // start function to uploade img
            var inputElement = document.getElementById("imageUpload");

            // Ajoutez un gestionnaire d'événements pour écouter le changement de fichier
            inputElement.addEventListener("change", handleFiles, false);

            function handleFiles() {
            // Récupérez le fichier sélectionné par l'utilisateur
            var file = this.files[0];
            console.log("Fichier sélectionné : ", file);

            // Créez une nouvelle instance de FileReader
            var reader = new FileReader();

            // Ajoutez un gestionnaire d'événements pour écouter la fin de la lecture du fichier
            reader.onload = function(event) {
                // Créez une nouvelle instance d'image
                var img = new Image();

                // Définissez le gestionnaire d'événements pour lorsque l'image est chargée
                img.onload = function() {
                const minWidth = 300; // La largeur minimale souhaitée
                const minHeight = 300; // La longeur minimale souhaitée
                if (img.width >= minWidth && img.height >= minHeight) { 
                // Créez un élément canvas
                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');

                // Déterminez les dimensions de l'image redimensionnée
                var maxWidth = 800;
                var maxHeight = 600;
                var width = img.width;
                var height = img.height;

                // Vérifiez si l'image doit être redimensionnée
                if (width > maxWidth || height > maxHeight) {
                    // Calculez le facteur de redimensionnement
                    var ratio = Math.min(maxWidth / width, maxHeight / height);

                    // Appliquez le redimensionnement
                    width *= ratio;
                    height *= ratio;
                }

                // Définissez les dimensions du canvas
                canvas.width = width;
                canvas.height = height;

                // Dessinez l'image sur le canvas avec les nouvelles dimensions
                context.drawImage(img, 0, 0, width, height);

                // Obtenez le contenu de l'image redimensionnée sous forme de base64
                var base64Content = canvas.toDataURL('image/jpeg');
                base64Content = base64Content.replace(/^data:image\/jpeg;base64,/, '');
                //console.log("Contenu en base64 : ", base64Content);
                base64Contenttable.push(base64Content)
                // ...
                }else{
                    Swal.showValidationMessage(i18next.t('IDTRANSLATEFORM105'));
                    //alert(`Votre image est trop pétite. Veuillez sélectionner une image d'au moins 300x300 pixels.`)
                    inputElement.value = ""
                }
                };

                // Définissez la source de l'image comme le contenu du fichier
                img.src = event.target.result;
            };

            // Commencez la lecture du fichier
            reader.readAsDataURL(file);
            }
            // end function to uploade img
            var SENDIDVAL = document.getElementById("SENDID");
            SENDIDVAL.addEventListener('click', function(){
            const PieceID = base64Contenttable.slice(-1).pop();
            console.log(PieceID) 
            database.ref('utilisateurs/' + UserId).update({
            MESDEUXPHOTOS: PieceID
            }).then(() => {
                console.log('Mise à jour réussie !');
            }).catch(error => {
                console.error('Erreur lors de la mise à jour :', error);
            }); 
            })
            }
            }else{

            }
            }else{
            //xxxxxxxxxxxxx
            }
            } else {
                console.log("Aucune donnée trouvée pour cet utilisateur.");
            }
    })
    .catch(function(error) {
            console.error("Erreur lors de la récupération des données:", error);
    });
    //alert('Oui')
   }
    }
    genererLien()
   
    </script>
<script src="./../translate.js"></script>
<script src="usersendID.js"></script>
</body>
</html>